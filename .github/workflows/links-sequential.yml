name: sequential new link check

on: [push]

jobs:
  fetch-links:
    runs-on: ubuntu-latest
    outputs:
      flatpages-list: ${{ steps.flatpages-list.outputs.list }}
      articles-list: ${{ steps.articles-list.outputs.list }}
    steps:
    - id: flatpages-list
      run: |
         flatpages=$(curl http://206.12.88.113/flatpages-list/)
         echo $flatpages
         echo "list=$flatpages" >> $GITHUB_OUTPUT
    - id: articles-list
      run: |
        articles=$(curl http://206.12.88.113/articles-list/)
        echo $articles
        echo "list=$articles" >> $GITHUB_OUTPUT
  link-Checker:
    runs-on: ubuntu-latest
    needs: fetch-links
    steps:
      - id: fetch-link-checker
        name: fetch link checker
        run: |
          echo "*** Download the archive ***"
          wget "https://github.com/lycheeverse/lychee/releases/download/v0.13.0/lychee-v0.13.0-x86_64-unknown-linux-gnu.tar.gz"
          echo "*** extract the archive ***"
          tar -xvf lychee-v0.13.0-x86_64-unknown-linux-gnu.tar.gz
          echo "*** list directory ***"
          ls -l
      - id: link-flatpage
        name: link flatpage
        run : |
          for link in ${{ needs.fetch-links.outputs.flatpages-list }};
          do
            ./lychee \
              --exclude http:\/\/cantus\.sk.* \
              --no-progress \
              --format markdown \
              --output summary.md \
              $link

            echo "# $link" >> $GITHUB_STEP_SUMMARY
            cat summary.md >> $GITHUB_STEP_SUMMARY
          done

      - id: link-articles
        name: link articles
        run : |
          for link in ${{ needs.fetch-links.outputs.articles-list }};
          do
            ./lychee \
              --exclude http:\/\/cantus\.sk.* \
              --no-progress \
              $link

            echo "# $link" >> $GITHUB_STEP_SUMMARY
            cat summary.md >> $GITHUB_STEP_SUMMARY
          done